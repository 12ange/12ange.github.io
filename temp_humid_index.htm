<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,minimum-scale=1">
<title>æ¸©æ¹¿åº¦è¨ˆã®å€¤ã‹ã‚‰å„ç¨®æŒ‡æ•°ã‚’ç®—å‡º</title>
<script defer src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
<style>
input:valid {background-color:white;color:black}
input:invalid {background-color:black;color:white}
img.emoji {height:1em; margin:0 .05em 0 .1em; vertical-align:-0.1em; width:1em}
</style>
</head>
<body><!--
ref: https://www.daiichi-kagaku.co.jp/situdo/notes/note108.html

t = ä¹¾çƒæ¸©åº¦[â„ƒ]
h = ç›¸å¯¾æ¹¿åº¦[%RH]
d = éœ²ç‚¹æ¸©åº¦[â„ƒ]

e = æ°´è’¸æ°—åœ§[Pa]
E(x) = æ¸©åº¦xã®é£½å’Œæ°´è’¸æ°—åœ§[Pa]

h = 100*e/E(t) ... ç›¸å¯¾æ¹¿åº¦ã®å®šç¾©å¼
e = E(t)*h/100 ... ä¸Šå¼ã‚’eã«ã¤ã„ã¦ï¼šæ¸©æ¹¿åº¦è¨ˆã®èª­ã¿å–ã‚Š

æ¸©åº¦ã‹ã‚‰é£½å’Œæ°´è’¸æ°—åœ§ã¸ã®å¤‰æ›(0<=t<=100 åŒºé–“) (Sonntagã®å¼)
{
  T=t+273.15;
  ln( E(T) ) == -6096.9385*(1/T) + 21.2409642 -2.711193e-2*T +1.673952e-5*T*T +2.433502*ln(T);
  @returns E(T) = exp( å³è¾º );
}

é£½å’Œæ°´è’¸æ°—åœ§ã‹ã‚‰éœ²ç‚¹æ¸©åº¦ã¸ã®å¤‰æ›(611.213<e) 611.213[Pa]ã¯0.0â„ƒã®æ°´ã®é£½å’Œæ°´è’¸æ°—åœ§
{
  y=ln( e/611.213 );
  @returns d = 13.715*y + 8.4262e-1*y*y + 1.9048e-2*y*y*y + 7.8158e-3*y*y*y*y;
}

å¤å ´ç”¨ã«ä½¿ã†ã®ã§ã€æœ‰åŠ¹ãªå…¥åŠ›å€¤ã‚’
25 <= t (< 50)
30 <= h <= 100
ã«ç¸›ã£ã¦åˆ©ç”¨ã™ã‚‹å¼(ãƒ‘ãƒ©ãƒ¡ã‚¿)ã‚’é™å®šã™ã‚‹
--><h2>[å¤å­£å‘ã‘] æ¸©æ¹¿åº¦è¨ˆã®å€¤ã‹ã‚‰å„ç¨®æŒ‡æ•°ã‚’ç®—å‡º</h2>
<p id="notes">
ã”å®¶åº­ã«ã‚ã‚‹æ¸©æ¹¿åº¦è¨ˆã®å€¤ã‚’å…¥åŠ›ã™ã‚‹ã“ã¨ã§ã€å¿«é©æ€§è©•ä¾¡ã«ä½¿ã‚ã‚Œã‚‹å„ç¨®æŒ‡æ•°ã‚’ç®—å‡ºã—ã¾ã™ã€‚
<ul>
<li>æ¹¿çƒæ¸©åº¦ã¯1013.25[hPa]ã«ãŠã‘ã‚‹ç®—å‡ºå€¤ã§ã™ã€‚</li>
<li>é»’çƒæ¸©åº¦ã¯æ™´å¤©ã®ä¸€æ—¥å¹³å‡å€¤<small>(300[W/m&sup2;])</small>ãƒ»å¾®é¢¨<small>(1[m/s])</small>ç’°å¢ƒã§ã®æ¨å®šå€¤ã§ã™ã€‚
<br>æ—¥ä¸­ã¯ä¸ŠãŒã‚Šã€å¤œé–“ã¯ä¸‹ãŒã‚Šã€æ›‡å¤©ã‚„é¢¨ãŒå¹ã‘ã°ä¸‹ãŒã‚Šã¾ã™ã€‚</li>
<li>æ¹¿çƒé»’çƒæ¸©åº¦ã¯ä¸Šè¨˜ã«åŠ ãˆã€å±‹å†…ã®è©•ä¾¡å¼<small>(0.7æ¹¿çƒæ¸©åº¦+0.3é»’çƒæ¸©åº¦)</small>ã§ã™ã€‚</li>
</ul>
</p>
<fieldset>
	<legend>æ¸¬å®šã•ã‚ŒãŸå€¤</legend>
	<div>
		<span>ğŸŒ¡ï¸ æ¸©åº¦</span>
		<input type="number" id="iTemp" required min="25" max="49.9" step="0.1" value="30">
		<span>â„ƒ</span>
		<span id="limitTemp"></span>
	</div>
	<div>
		<span>ğŸ’§ æ¹¿åº¦</span>
		<input type="number" id="iHumid" required min="30" max="99" step="1" value="60">
		<span>%</span>
		<span id="limitHumid"></span>
	</div>
</fieldset>
<fieldset>
	<legend>æ›ç®—çµæœ</legend>
	<table>
		<caption>å„ç¨®æŒ‡æ•°</caption>
		<tr><td>ğŸ‡¯ğŸ‡µ ä¸å¿«æŒ‡æ•°</td><td id="oTmpHmdIdx">0</td><td>(å˜ä½ãªã—)</td><td id="xTmpHmdIdx">???</td></tr>
		<tr><td>ğŸ‡ºğŸ‡¸ Heat Index</td><td id="oHeatIndex">0</td><td>(â„‰)</td><td id="xHeatIndex">???</td></tr>
		<tr><td>ğŸ‡¨ğŸ‡¦ Humidex</td><td id="oHumidex">0</td><td>(â„ƒ)</td><td id="xHumidex">???</td></tr>
	</table>
	<table>
		<caption>æ¸©åº¦ã¨æ¹¿åº¦</caption>
		<tr><td>ğŸŒ¡ï¸ï¸âš« é»’çƒæ¸©åº¦</td><td id="oTempGlb">0</td><td>â„ƒ</td><td>æ™´å¤©å¾®é¢¨ä¸‹ã®æ¨å®šå€¤</td></tr>
		<tr><td>ğŸŒ¡ï¸ï¸ã€€ ä¹¾çƒæ¸©åº¦</td><td id="oTempDry">0</td><td>â„ƒ</td><td>æ¸¬å®šå€¤</td></tr>
		<tr><td>â˜ï¸âš« æ¹¿çƒé»’çƒæ¸©åº¦</td><td id="oWetGlbTmp">0</td><td>â„ƒ</td><td>å±‹å†…ãƒ»æ™´å¤©å¾®é¢¨ä¸‹ã®æ¨å®šå€¤</td></tr>
		<tr><td>ğŸŒ¡ï¸â˜ï¸ æ¹¿çƒæ¸©åº¦</td><td id="oTempWet">0</td><td>â„ƒ</td><td>ç®—å‡ºå€¤</td></tr>
		<tr><td>ğŸŒ¡ï¸ğŸŒ§ï¸ éœ²ç‚¹æ¸©åº¦</td><td id="oTempDew">0</td><td>â„ƒ</td><td>ç®—å‡ºå€¤</td></tr>
		<tr><td>ğŸ’§ã€€ ç›¸å¯¾æ¹¿åº¦</td><td id="oRelHumid">0</td><td>%</td><td>æ¸¬å®šå€¤</td></tr>
	</table>
</fieldset>
<p>çµµæ–‡å­—ã¯<a href="https://github.com/twitter/twemoji">Twemoji</a>ã‚’ãŠå€Ÿã‚Šã—ã¦ã„ã¾ã™ã€‚</p>
<script>
"use strict";
//================ å„ç¨®æ–¹ç¨‹å¼ã‚„ã‚µãƒ–ãƒ«ãƒ¼ãƒãƒ³ ================//

function ttoe(_t){ //å¼•æ•°ã¯æ‘‚æ°æ¸©åº¦ã€è¿”ã‚Šå€¤ã¯é£½å’Œæ°´è’¸æ°—åœ§
	_t+=273.15; //æ‘‚æ°æ¸©åº¦ã‚’çµ¶å¯¾æ¸©åº¦ã«
	return Math.exp( -6096.9385*(1/_t) + 21.2409642 -2.711193e-2*_t +1.673952e-5*_t*_t +2.433502*Math.log(_t) );
}
const eZero = ttoe(0);
function etot(_e){ //å¼•æ•°ãŒé£½å’Œæ°´è’¸æ°—åœ§ã®æ™‚ã€è¿”ã‚Šå€¤ã¯éœ²ç‚¹æ¸©åº¦
	let y = Math.log( _e/eZero );
	return 13.715*y + 8.4262e-1*y*y + 1.9048e-2*y*y*y + 7.8158e-3*y*y*y*y;
}
function tdew(_t,_rh){ //å¼•æ•°ã¯ä¹¾çƒæ¸©åº¦ã¨ç›¸å¯¾æ¹¿åº¦
	return etot( ttoe(_t)*_rh/100 );
}
// https://ja.wikipedia.org/wiki/%E4%B8%8D%E5%BF%AB%E6%8C%87%E6%95%B0
function fukaisisuu_raw(_t,_rh){ //å¼•æ•°ã¯ä¹¾çƒæ¸©åº¦ã¨ç›¸å¯¾æ¹¿åº¦
	return .81*_t + .01*_rh*(.99*_t-14.3) + 46.3;
}
// https://en.wikipedia.org/wiki/Humidex
function humidex_raw(_tair,_tdew){ //å¼•æ•°ã¯ä¹¾çƒæ¸©åº¦ã¨éœ²ç‚¹æ¸©åº¦
	return _tair+0.5555*( 6.11*Math.exp( 5417.7530*( 1/273.16-1/(273.15+_tdew) ) )-10 );
}
// https://en.wikipedia.org/wiki/Heat_index
function heatindex_raw(_t,_r){ //å¼•æ•°ã¯**è¯æ°**ä¹¾çƒæ¸©åº¦ã¨ç›¸å¯¾æ¹¿åº¦
	const arrC = [16.923, .185212, 5.37941, -.100254, 9.41695e-3, 7.28898e-3, 3.45372e-4, -8.14971e-4, 1.02102e-5, -3.8646e-5, 2.91583e-5, 1.42721e-6, 1.97483e-7, -2.18429e-8, 8.43296e-10, -4.81975e-11];
	const arrP = [1, _t, _r, _t*_r, _t*_t, _r*_r, _t*_t*_r, _t*_r*_r, _t*_t*_r*_r, _t*_t*_t, _r*_r*_r, _t*_t*_t*_r, _t*_r*_r*_r, _t*_t*_t*_r*_r, _t*_t*_r*_r*_r, _t*_t*_t*_r*_r*_r];
	return arrC.reduce( (a,c,i)=>a+c*arrP[i] , 0);
}
function tctotf(_t){ //å¼•æ•°ã¯æ‘‚æ°æ¸©åº¦ã€è¿”ã‚Šå€¤ã¯è¯æ°æ¸©åº¦
	return _t*9/5+32;
}
//https://www.daiichi-kagaku.co.jp/situdo/notes/note105.html
function testTwet(_t,_rh){ //å¼•æ•°ã¯ä¹¾çƒæ¸©åº¦ã¨ç›¸å¯¾æ¹¿åº¦ã€è¿”ã‚Šå€¤ã¯æ¹¿çƒæ¸©åº¦ã®æ¨æ¸¬å€¤
	//Sprungã®å…¬å¼ e = E(w)-A*P*(t-w)
	const ap = .000662*101325; //A=ä¹¾æ¹¿è¨ˆä¿‚æ•°(æ¹¿çƒãŒæ°·çµã—ã¦ã„ãªã„æ™‚),P=å¤§æ°—åœ§[Pa]
	//å…¬å¼ã‚’å¤‰å½¢ã—ã¦ e+A*P*t = E(w)+A*P*w
	const vLeft = ttoe(_t)*_rh/100 + ap*_t;
	const fRight = w => ttoe(w)+ap*w;

	//vLeft == vRight ã¨ãªã‚‹ w : vRight=fRight(w) ã‚’æ±‚ã‚ãŸã„ã€‚æŒŸã¿æ’ƒã¡æ³•ã€‚
	//åˆæœŸå€¤ã®ä½ã„ã»ã†ã¯éœ²ç‚¹æ¸©åº¦ã€é«˜ã„ã»ã†ã¯ä¹¾çƒæ¸©åº¦ã€‚
	let low_temp = tdew(_t,_rh), hi_temp = _t;
	let low_val = fRight(low_temp), hi_val = fRight(hi_temp);
	let floor = v=>v|0;
	while( floor(low_temp*10)<floor(hi_temp*10) ){
		let tau = (vLeft-low_val)/(hi_val-low_val); //å€¤ã®å·®ã‚’[0,1]ã«ä¸¸ã‚ã¦
		let mid_temp = low_temp+tau*(hi_temp-low_temp); //æ¸©åº¦ã«åæ˜ 
		let mid_val = fRight(mid_temp);
		if( mid_val < vLeft ){
			low_val = mid_val; low_temp = mid_temp;
		}else{
			hi_val = mid_val; hi_temp = mid_temp;
		}
	}
	return floor(low_temp*10)/10;
}
//http://www.heat-island.jp/web_journal/2013.html -> 13A003ã€Œå²¡ç”°ãƒ»æ—¥ä¸‹ã®é»’çƒæ¸©åº¦æ¨å®šå¼ã®åºƒåŸŸé©ç”¨ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ã€ã‚ˆã‚Š
function supposedTglobe(_tdry,_insol,_vwind){ //å¼•æ•°ã¯ä¹¾çƒæ¸©åº¦ã€æ—¥å°„é‡[W/m^2]ã¨é¢¨é€Ÿ[m/s]
	return _tdry+(_insol-38.5)/(.0217*_insol+4.35*_vwind+23.5);
}
//æ™´å¤©å¾®é¢¨å¤©å€™æ¡ä»¶ã§ã®æ¨å®šå€¤
function sunnybreezeTglobe(_tdry){
	//éå»ã®å…¨å¤©æ—¥å°„é‡ https://www.data.jma.go.jp/obd/stats/etrn/index.php ã®åœ°ä¸Šæ°—è±¡è¦³æ¸¬åœ°ç‚¹
	//æ—¥å°„é‡ã‚’ä»®ã«300[W/m^2]ã¨ãŠãã€‚å…¨å¤©æ—¥å°„é‡ã®(300*86400[s]=)25.92[MJ/m^2]ã«ç›¸å½“ã™ã‚‹ã€‚
	// 50 |  4.32 | é›¨
	//222 | 19.18 | æ›‡
	//300 | 25.92 | æ™´
	//é¢¨é€Ÿã‚’ä»®ã«1[m/s]ã¨ãŠãã€‚
	return supposedTglobe(_tdry,300,1);
}

//================ toHTML ================//
const GET_ID = id => document.getElementById(id);

//è¤‡æ•°ãƒœãƒ¼ãƒ€ãƒ¼ã®ã©ã“ã«ãªã‚‹ã‹ã€‚æ˜‡é †ã‚’ä¿ã£ãŸã¾ã¾æŒ¿å…¥ã•ã‚ŒãŸæ™‚ã®indexå€¤ã«ç­‰ã—ã„
function value_rank( _arr_sort_asc, _v ){
	let i=_arr_sort_asc.length-1;
	while( i>=0 ){
		if(_arr_sort_asc[i]<=_v){
			return i+1;
		}else{
			i--;
		}
	}
	return 0;
}

//ä¸å¿«æŒ‡æ•°{å¿«ã„<70<=æš‘ããªã„<75<=ã‚„ã‚„æš‘ã„<80<=æš‘ãã¦æ±—ãŒå‡ºã‚‹<85<=æš‘ãã¦ãŸã¾ã‚‰ãªã„} 69-121
const border_thix = [70,75,80,85];
const message_thix = ["å¿«ã„","æš‘ããªã„","ã‚„ã‚„æš‘ã„","æš‘ãã¦æ±—ãŒå‡ºã‚‹","æš‘ãã¦ãŸã¾ã‚‰ãªã„"];
//HeatIndex{clear<80<=caution<90=<extreme_caution<105=<danger<130=<extreme_danger} 76-373
const border_heat = [80,90,105,130];
const message_heat = ["(clear)","Caution","Extreme Caution","Danger","Extreme Danger"];
//Humidex{clear<20<=little_to_no_discomfort<30<=some_disc.<40<=great_disc.<=45<dangerous} 24-116
const border_hmdx = [20,30,40,46];
const message_hmdx = ["(clear)","Little To No Discomfort","Some Discomfort","Great Discomfort","Dangerous"];
//æ¹¿çƒé»’çƒæ¸©åº¦ãƒ»æš‘ã•æŒ‡æ•°ãƒ»WBGT
const border_wbgt = [21,25,28,31];
const message_wbgt = ["(å¹³å¸¸)","æ³¨æ„","è­¦æˆ’","å³é‡è­¦æˆ’","å±é™º"]

//æ›ç®—çµæœã‚’å†è¨ˆç®—
function recalculate(){
	const iTemp = GET_ID("iTemp");
	const iHumid = GET_ID("iHumid");
	if( !iTemp.validity.valid || !iHumid.validity.valid ){return;}

	const floor = v=>v|0;
	const floor10 = v=>((10*v)|0)/10;
	let tdry = iTemp.valueAsNumber;
	let rhmd = iHumid.valueAsNumber;
	let tdpt = tdew(tdry,rhmd);
	let twet = testTwet(tdry,rhmd);
	let stgl = sunnybreezeTglobe(tdry);
	let swgt = .7*twet+.3*stgl;
	let thix = floor( fukaisisuu_raw(tdry,rhmd) );
	let heat = floor( heatindex_raw(tctotf(tdry),rhmd) );
	let hmdx = floor( humidex_raw(tdry,tdpt) );

	GET_ID("oTempDry").textContent = floor10(tdry);
	GET_ID("oRelHumid").textContent = floor(rhmd);
	GET_ID("oTempDew").textContent = floor10(tdpt);
	GET_ID("oTempWet").textContent = floor10(twet);
	GET_ID("oTempGlb").textContent = floor10(stgl);
	GET_ID("oWetGlbTmp").textContent = floor10(swgt);

	const xofy = (x,y,cc)=>{
		let s="";
		while(x>0){s+=cc[0];x--;y--;}
		while(y>0){s+=cc[1];y--;}
		return s;
	};

	//(IDå…±é€šéƒ¨ã€ãƒœãƒ¼ãƒ€ãƒ¼å€¤é…åˆ—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—ã€é©ç”¨å€¤)
	const subroutine = (_idCommon,_aBorder,_aMessage,_value)=>{
		let elmO = GET_ID("o"+_idCommon);
		let elmX = GET_ID("x"+_idCommon);
		let rank = value_rank(_aBorder,_value);
		elmO.textContent = _value;
		elmX.textContent = xofy(rank+1,_aMessage.length,"âš â–ª") +" "+ _aMessage[rank];
		twemoji.parse(elmX); //twemoji installed
	};
	subroutine("TmpHmdIdx",border_thix,message_thix,thix);
	subroutine("HeatIndex",border_heat,message_heat,heat);
	subroutine("Humidex"  ,border_hmdx,message_hmdx,hmdx);
}

window.addEventListener("load",()=>{
	twemoji.parse(document.body); //twemoji installed

	const iTemp = GET_ID("iTemp");
	const iHumid = GET_ID("iHumid");
	GET_ID("limitTemp").textContent = `(${iTemp.min}~${iTemp.max}${iTemp.nextElementSibling.textContent})`;
	GET_ID("limitHumid").textContent = `(${iHumid.min}~${iHumid.max}${iHumid.nextElementSibling.textContent})`;

	//å…¥åŠ›å€¤ãŒå¤‰ã‚ã‚‹ãŸã³ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã‚ˆã†ã«
	iTemp.addEventListener("input",recalculate);
	iHumid.addEventListener("input",recalculate);
	recalculate();
});

</script>
</body>
</html>
